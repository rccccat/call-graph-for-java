name: Build & Release

on:
  push:
    branches: [ main ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Fetch Sources
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Prepare Plugin Artifact
        id: artifact
        shell: bash
        run: |
          cd ${{ github.workspace }}/build/distributions
          FILENAME=`ls *.zip`
          unzip "$FILENAME" -d content

          echo "filename=${FILENAME:0:-4}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifact.outputs.filename }}
          path: ./build/distributions/content/*/*

  test:
    name: Test
    needs: [ build ]
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Fetch Sources
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Run Tests
        run: ./gradlew check

      - name: Collect Tests Result
        if: ${{ failure() }}
        uses: actions/upload-artifact@v5
        with:
          name: tests-result
          path: ${{ github.workspace }}/build/reports/tests

      - name: Upload Code Coverage Report
        uses: codecov/codecov-action@v5
        with:
          files: ${{ github.workspace }}/build/reports/kover/report.xml
          token: ${{ secrets.CODECOV_TOKEN }}

  inspectCode:
    name: Inspect code
    needs: [ build ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write
      pull-requests: write
    steps:
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Fetch Sources
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - name: Qodana - Code Inspection
        uses: JetBrains/qodana-action@v2025.1.1
        with:
          cache-default-branch-only: true

  release:
    name: Release
    if: github.event_name != 'pull_request'
    needs: [ build, test, inspectCode ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Build Plugin
        run: ./gradlew buildPlugin

      - name: Get Version and Commit Info
        id: version
        run: |
          VERSION=$(./gradlew properties --property version --quiet --console=plain | tail -n 1 | cut -f2- -d ' ')
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u '+%Y%m%d-%H%M')
          TAG_NAME="v${VERSION}-${TIMESTAMP}-${COMMIT_SHORT}"

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

          echo "Generated tag: $TAG_NAME"

      - name: Create Release with Plugin
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: "Call Graph for Java ${{ steps.version.outputs.VERSION }} - ${{ steps.version.outputs.COMMIT_SHORT }}"
          body: |
            ## ðŸ“¦ Call Graph for Java - è‡ªåŠ¨å‘å¸ƒ

            **ç‰ˆæœ¬:** `${{ steps.version.outputs.VERSION }}`
            **æäº¤:** [`${{ steps.version.outputs.COMMIT_SHORT }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **æž„å»ºæ—¶é—´:** `${{ steps.version.outputs.TIMESTAMP }}`
            **æäº¤ä¿¡æ¯:** ${{ github.event.head_commit.message }}


            ### ðŸ“¥ å®‰è£…æ–¹æ³•:
            1. ä¸‹è½½ä¸‹æ–¹çš„ `call-graph-for-java-${{ steps.version.outputs.VERSION }}.zip`
            2. IntelliJ IDEA â†’ `Settings` â†’ `Plugins` â†’ `âš™ï¸ Install from Disk`
            3. é€‰æ‹© zip æ–‡ä»¶å¹¶é‡å¯ IDE

            ### ðŸ”§ å¿«é€Ÿå¼€å§‹:
            - å³é”®ç‚¹å‡»ä»»æ„æ–¹æ³• â†’ **ã€Œç”Ÿæˆè°ƒç”¨å›¾ã€**
            - é…ç½®: `Settings` â†’ `Tools` â†’ `Call Graph`

            ---
            *ðŸ¤– æ­¤å‘å¸ƒç”±æŽ¨é€åˆ° main åˆ†æ”¯è‡ªåŠ¨è§¦å‘*
          files: build/distributions/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Plugin Version | \`${{ steps.version.outputs.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit | [\`${{ steps.version.outputs.COMMIT_SHORT }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Release Tag | \`${{ steps.version.outputs.TAG_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Build Time | \`${{ steps.version.outputs.TIMESTAMP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f build/distributions/*.zip ]; then
            echo "âœ… **Plugin built successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Generated Files:**" >> $GITHUB_STEP_SUMMARY
            for file in build/distributions/*.zip; do
              if [ -f "$file" ]; then
                size=$(du -h "$file" | cut -f1)
                echo "- \`$(basename "$file")\` (${size})" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **Release:** [v${{ steps.version.outputs.VERSION }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG_NAME }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Plugin build failed**" >> $GITHUB_STEP_SUMMARY
          fi
